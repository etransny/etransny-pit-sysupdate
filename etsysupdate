#!/bin/bash
# ;;/;&
# use exit code 64 to reboot system on exit
notify(){
  logger -t $app "$*"
  echo "$*"
}


check_update(){
  if [ $updated -eq 0 ]
  then
    apt-get update
    if [ $? -eq 0 ]
    then
      updated=1    
    else
      notify "Update to v.$1 failed in updating packages"
      exit 1
    fi
  fi

}

app=SYSUPDATE
if [ "$(id -u)" != "0" ]; then
	notify "Not root"
	exit 1
fi
etver=$(cat /etc/etransver)
updated=0
case "$etver" in
  20180405)
    myVal=$(cat /proc/cpuinfo | grep -Po '([0-9,a-f]{16})')
    #if [ "0000000019438c0c" = "$myVal" ]
    #then
      newVer="20181001"
      notify "Updating to $newVer"
      check_update "$newVer"
      apt-get install -y pigpio python-pigpio python3-pigpio ntpdate
      if [ $? -eq 0 ]
      then
        sed -i -- 's/pigpiod -l/pigpiod/g' /lib/systemd/system/pigpiod.service && systemctl enable pigpiod.service && systemctl start pigpiod.service
        sed -i -- 's/maxfail 3/maxfail 5/g' /usr/local/bin/xgconn
        tmpScript=$(wget --no-cache -qO- https://raw.githubusercontent.com/D2Edev/et2/master/syncByGps) && echo "$tmpScript" > /usr/local/bin/gpstimesync
        wget -P /usr/local/bin/ https://raw.githubusercontent.com/D2Edev/et2/master/syncByNtp && chmod +x /usr/local/bin/syncByNtp && sed -i '7 a syncByNtp &' /usr/local/bin/etupdate && systemctl stop systemd-timesyncd.service && systemctl disable systemd-timesyncd.service
        tmpScript=$(wget --no-cache -qO- https://raw.githubusercontent.com/D2Edev/et2/master/rc.local) && echo "$tmpScript" > /etc/rc.local
        echo "$newVer" > /etc/etransver
      fi
    #fi
    exit 64
  # no fallthru here 
    ;;
  20180606)
    myVal=$(cat /proc/cpuinfo | grep -Po '([0-9,a-f]{16})')
    #if [ "0000000019438c0c" = "$myVal" ]
    #then
      newVer="20181002"
      notify "Updating to $newVer"
      check_update "$newVer"
      apt-get install -y pigpio python-pigpio python3-pigpio ntpdate
      if [ $? -eq 0 ]
      then
        sed -i -- 's/pigpiod -l/pigpiod/g' /lib/systemd/system/pigpiod.service && systemctl enable pigpiod.service && systemctl start pigpiod.service
        sed -i -- 's/maxfail 3/maxfail 5/g' /usr/local/bin/xgconn
        tmpScript=$(wget --no-cache -qO- https://raw.githubusercontent.com/D2Edev/et2/master/syncByGps) && echo "$tmpScript" > /usr/local/bin/gpstimesync
        wget -P /usr/local/bin/ https://raw.githubusercontent.com/D2Edev/et2/master/syncByNtp && chmod +x /usr/local/bin/syncByNtp && sed -i '7 a syncByNtp &' /usr/local/bin/etupdate && systemctl stop systemd-timesyncd.service && systemctl disable systemd-timesyncd.service
        tmpScript=$(wget --no-cache -qO- https://raw.githubusercontent.com/D2Edev/et2/master/rc.local) && echo "$tmpScript" > /etc/rc.local
        echo "$newVer" > /etc/etransver
      fi
    #fi
    exit 64
  # no fallthru here 
    ;;
  20180613)
    notify "Updating to v.20180911"
    check_update 20180911
    apt-get install -y pigpio python-pigpio python3-pigpio && sed -i -- 's/pigpiod -l/pigpiod/g' /lib/systemd/system/pigpiod.service && systemctl enable pigpiod.service && systemctl start pigpiod.service && sed -i -- 's/20180613/20180911/g' /etc/etransver
    ;&
  20180911)
    newVer="20181005"
    notify "Updating to $newVer"
  #  check_update $newVer
    #if [ "0000000019438c0c" = "$myVal" ]
    #then
      check_update "$newVer"
      sed -i -- 's/maxfail 3/maxfail 5/g' /usr/local/bin/xgconn
      tmpScript=$(wget --no-cache -qO- https://raw.githubusercontent.com/D2Edev/et2/master/syncByGps) && echo "$tmpScript" > /usr/local/bin/gpstimesync
      apt-get install -y ntpdate
      if [ $? -eq 0 ]
      then
        wget -P /usr/local/bin/ https://raw.githubusercontent.com/D2Edev/et2/master/syncByNtp && chmod +x /usr/local/bin/syncByNtp && sed -i '7 a syncByNtp &' /usr/local/bin/etupdate && systemctl stop systemd-timesyncd.service && systemctl disable systemd-timesyncd.service
        tmpScript=$(wget --no-cache -qO- https://raw.githubusercontent.com/D2Edev/et2/master/rc.local) && echo "$tmpScript" > /etc/rc.local
        sed -i -- 's/20180911/20181005/g' /etc/etransver
      fi
    #fi
    exit 64
  # no fallthru here 
    ;;
  20181005)
    #myVal=$(cat /proc/cpuinfo | grep -Po '([0-9,a-f]{16})')
    #if [ "00000000aee84a62" != "$myVal" ]
    #then
    #  exit 0
    #fi
    newVer="20181214"
    notify "Updating to $newVer"
    apt-get install -y i2c-tools
    tmpScript=$(wget --no-cache -qO- https://raw.githubusercontent.com/D2Edev/et2/master/send2port) && echo "$tmpScript" > /usr/local/bin/send2port && chmod +x /usr/local/bin/send2port
    tmpScript=$(wget --no-cache -qO- https://raw.githubusercontent.com/D2Edev/et2/master/96-usb3g4gmodem.rules) && echo "$tmpScript" > /lib/udev/rules.d/96-usb3g4gmodem.rules
    sed -i -- 's/DEVICES="\/dev\/gps0"/DEVICES=""/g' /etc/default/gpsd
    sed -i -- 's/#dtparam=i2c_arm=on/dtparam=i2c_arm=on/g' /boot/config.txt
    ;;
  *)
    notify "Unknown local version: $etver. Exit"
    exit 1  
esac
exit 0
